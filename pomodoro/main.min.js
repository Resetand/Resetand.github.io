"use strict";var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"==typeof b||"function"==typeof b)?b:a}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var EventEmitter=function(){function a(){_classCallCheck(this,a),this.events={}}return _createClass(a,[{key:"subscribe",value:function(a,b){this.events[a]=this.events[a]||[],this.events[a].push(b)}},{key:"notify",value:function(a,b){this.events[a]&&this.events[a].forEach(function(a){return a(b)})}}]),a}(),events=new EventEmitter;function converToHms(a){var b=Math.floor(a/3600),c=Math.floor(a/60)%60,d=a%60;return""+(b?b+" : ":"")+(10<=c?c+" : ":"0"+c+" : ")+(10<=d?d:"0"+d)}function converToHmsObj(a){var b=Math.floor(a/3600),c=Math.floor(a/60)%60;return{h:b,m:c,s:a%60}}function hmsToSec(a){return 3600*a.h+60*a.m+a.s}function editToDisplay(a){return 10<=+a?a:"0"+a}function cleanValue(a){return a=parseInt(a),60<a?59:0>a?0:isNaN(a)?0:a}function save(a){var b=JSON.stringify(a);localStorage.setItem("todos",b)}function load(){var a=localStorage.getItem("todos"),b=JSON.parse(a);return b}function changeFavicon(a){var b=document.createElement("link"),c=document.getElementById("dynamic-favicon");b.id="dynamic-favicon",b.rel="shortcut icon",b.href=a,c&&document.head.removeChild(c),document.head.appendChild(b)}var Model=function(a){function b(){_classCallCheck(this,b);var a=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.workTime=load()?load().workTime:1500,a.restTime=load()?load().restTime:300,a.coffeeTime=load()?load().coffeeTime:900,a.currentTime=0,a.pomodoroCounter=0,a.coffeeEveryNum=4,a.state={work:!1,rest:!1,coffee:!1},a}return _inherits(b,a),_createClass(b,[{key:"changeDefault",value:function(a,b,c){this.workTime=a,this.restTime=b,this.coffeeTime=c,events.notify("defaultDataChange")}},{key:"currentState",value:function(){var a=this;return Object.keys(this.state).filter(function(b){return a.state[b]}).join("")}},{key:"nextState",value:function(){var a=this.currentState();this.state[a]=!1,"work"===a?this.pomodoroCounter&&0==this.pomodoroCounter%this.coffeeEveryNum?this.state.coffee=!0:this.state.rest=!0:"coffee"===a?(this.state.work=!0,this.pomodoroCounter++):"rest"===a&&(this.state.work=!0,this.pomodoroCounter++),events.notify("stateChange",this.currentState())}},{key:"changeState",value:function(a){var b=this;Object.keys(this.state).forEach(function(a){return b.state[a]=!1}),a in this.state?(this.state[a]=!0,events.notify("stateChange",this.currentState())):console.error("Wrong state input")}},{key:"getCurrentTime",value:function(){return this.currentTime}},{key:"setCurrentAsWork",value:function(){this.currentTime=this.workTime,events.notify("currentChange",this.currentTime)}},{key:"setCurrentAsRest",value:function(){this.currentTime=this.restTime,events.notify("currentChange",this.currentTime)}},{key:"setCurrentAsCoffee",value:function(){this.currentTime=this.coffeeTime,events.notify("currentChange",this.currentTime)}},{key:"tick",value:function(){this.currentTime--,events.notify("currentChange",this.currentTime)}},{key:"resetModel",value:function(){var a=this;this.pomodoroCounter=0,this.currentTime=this.workTime,Object.keys(this.state).forEach(function(b){return a.state[b]=!1}),events.notify("stateChange",this.currentState()),events.notify("currentChange",this.currentTime)}}]),b}(EventEmitter),View=function(a){function b(a){_classCallCheck(this,b);var c=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.model=a,c.timer=document.getElementById("time"),c.state=document.getElementById("state"),c.progressBar=document.getElementById("progressBar"),c.startBtn=document.getElementById("start"),c.pauseBtn=document.getElementById("pause"),c.brakeBtn=document.getElementById("brake"),c.coffeeBtn=document.getElementById("coffee"),events.subscribe("currentChange",c.changeTime.bind(c)),events.subscribe("currentChange",c.changeProgress.bind(c)),events.subscribe("currentChange",c.changeTitleTime.bind(c)),events.subscribe("stateChange",c.onStateChange.bind(c)),events.subscribe("stateChange",c.changeProgress.bind(c)),c.timer.textContent=converToHms(c.model.workTime),c}return _inherits(b,a),_createClass(b,[{key:"defaultView",value:function(){document.title="Pomodoro Timer",changeFavicon("./img/work.ico")}},{key:"stateChangeEffect",value:function(a){var b=this;this.state.style.opacity=0,setTimeout(function(){b.state.style.opacity=1,b.state.textContent=a},300)}},{key:"onStateChange",value:function(a){"work"===a?(console.log("state for view changed"),this.stateChangeEffect("Code time !"),changeFavicon("./img/work.ico"),this.progressBar.style.backgroundColor="#d2494a"):"rest"===a?(console.log("state for view changed"),this.stateChangeEffect("Rest time !"),changeFavicon("./img/rest.ico"),this.progressBar.style.backgroundColor="rgb(74, 197, 32)"):"coffee"===a?(console.log("state for view changed"),this.stateChangeEffect("Coffee time !"),changeFavicon("./img/rest.ico"),this.progressBar.style.backgroundColor="rgb(74, 197, 32)"):this.state.style.opacity=0}},{key:"getFullTimeByState",value:function(a){return"work"===a?this.model.workTime:"rest"===a?this.model.restTime:"coffee"===a?this.model.coffeeTime:"zero"}},{key:"changeTime",value:function(a){this.timer.textContent=converToHms(a)}},{key:"changeTitleTime",value:function(a){document.title=converToHms(a)}},{key:"changeProgress",value:function(a){var b,c=this.getFullTimeByState(this.model.currentState());return b="zero"===c?0:100-100*a/c,this.progressBar.style.width=b+"%",b}}]),b}(EventEmitter),Controller=function(a){function b(a,c){_classCallCheck(this,b);var d=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return d.model=a,d.view=c,d.timerId=void 0,d.view.startBtn.addEventListener("click",d.startClick.bind(d)),d.view.pauseBtn.addEventListener("click",d.pauseClick.bind(d)),d.view.brakeBtn.addEventListener("click",d.brakeClick.bind(d)),d.view.coffeeBtn.addEventListener("click",d.coffeeClick.bind(d)),events.subscribe("stateChange",d.onStateChange.bind(d)),events.subscribe("defaultDataChange",d.brakeClick.bind(d)),d}return _inherits(b,a),_createClass(b,[{key:"onStateChange",value:function(a){"work"===a?this.work():"rest"===a?this.rest():"coffee"===a?this.coffee():void 0}},{key:"timerWorking",value:function(){var a=this;clearInterval(this.timerId);var b=setInterval(function(){0<a.model.getCurrentTime()?a.model.tick():a.model.nextState()},1e3);this.timerId=b}},{key:"work",value:function(){clearInterval(this.timerId),this.model.setCurrentAsWork(),this.timerWorking()}},{key:"rest",value:function(){clearInterval(this.timerId),this.model.setCurrentAsRest(),this.timerWorking()}},{key:"coffee",value:function(){clearInterval(this.timerId),this.model.setCurrentAsCoffee(),this.timerWorking()}},{key:"startClick",value:function(){var a=this.model.currentState();a?this.timerWorking():this.model.changeState("work")}},{key:"pauseClick",value:function(){clearInterval(this.timerId)}},{key:"brakeClick",value:function(){clearInterval(this.timerId),this.model.setCurrentAsWork(),this.model.resetModel(),this.view.defaultView()}},{key:"coffeeClick",value:function(){this.model.changeState("coffee"),this.model.pomodoroCounter=0}}]),b}(EventEmitter),EditModel=function(){function a(b){_classCallCheck(this,a),this.mianModel=b,this.workTime=converToHmsObj(this.mianModel.workTime),this.restTime=converToHmsObj(this.mianModel.restTime),this.coffeeTime=converToHmsObj(this.mianModel.coffeeTime)}return _createClass(a,[{key:"changeMainData",value:function(){this.mianModel.changeDefault(hmsToSec(this.workTime),hmsToSec(this.restTime),hmsToSec(this.coffeeTime)),save({workTime:hmsToSec(this.workTime),restTime:hmsToSec(this.restTime),coffeeTime:hmsToSec(this.coffeeTime)})}},{key:"plusMin",value:function(a){"work"===a?this.workTime.m+=1:"rest"===a?this.restTime.m+=1:"coffee"===a?this.coffeeTime.m+=1:void 0,events.notify("typeTimeChange",a)}},{key:"minusMin",value:function(a){"work"===a?this.workTime.m-=1:"rest"===a?this.restTime.m-=1:"coffee"===a?this.coffeeTime.m-=1:console.error("Wrong timeType for \"minusMin\""),events.notify("typeTimeChange",a)}},{key:"getTime",value:function(){return{workTime:this.workTime,restTime:this.restTime,coffeeTime:this.coffeeTime}}},{key:"changeMin",value:function(a,b){"work"===a?this.workTime.m=b:"rest"===a?this.restTime.m=b:"coffee"===a?this.coffeeTime.m=b:console.error("Wrong timeType for \"changeTime\""),events.notify("typeTimeChange",a)}},{key:"changeSec",value:function(a,b){"work"===a?this.workTime.s=b:"rest"===a?this.restTime.s=b:"coffee"===a?this.coffeeTime.s=b:console.error("Wrong timeType for \"changeTime\""),events.notify("typeTimeChange",a)}}]),a}(),EditView=function(){function a(b){_classCallCheck(this,a),this.editModel=b,this.modal=document.getElementById("editModal"),this.workBlock=document.getElementById("editWork"),this.restBlock=document.getElementById("editRest"),this.coffeeBlock=document.getElementById("editCoffee"),this.editBtn=document.getElementById("edit"),this.closeBtn=document.getElementById("close"),events.subscribe("typeTimeChange",this.onDataChange.bind(this)),this.editBtn.addEventListener("click",this.openModal.bind(this)),this.closeBtn.addEventListener("click",this.closeModal.bind(this)),this.changeTime()}return _createClass(a,[{key:"changeTime",value:function(){var a=this.workBlock.querySelector("input[data-type='min'] "),b=this.workBlock.querySelector("input[data-type='sec']");a.value=editToDisplay(this.editModel.workTime.m),b.value=editToDisplay(this.editModel.workTime.s);var c=this.restBlock.querySelector("input[data-type='min'] "),d=this.restBlock.querySelector("input[data-type='sec']");c.value=editToDisplay(this.editModel.restTime.m),d.value=editToDisplay(this.editModel.restTime.s);var e=this.coffeeBlock.querySelector("input[data-type='min'] "),f=this.coffeeBlock.querySelector("input[data-type='sec']");e.value=editToDisplay(this.editModel.coffeeTime.m),f.value=editToDisplay(this.editModel.coffeeTime.s)}},{key:"openModal",value:function(){var a=this.modal;a.style.display="block";var b=setInterval(function(){1>+a.style.opacity?a.style.opacity=+a.style.opacity+.06:clearInterval(b)},5)}},{key:"closeModal",value:function(){var a=this.modal,b=setInterval(function(){0<+a.style.opacity?a.style.opacity=+a.style.opacity-.06:(a.style.display="none",clearInterval(b))},5)}},{key:"onDataChange",value:function(a){switch(a){case"work":var b=this.workBlock.querySelector("input[data-type='min'] "),c=this.workBlock.querySelector("input[data-type='sec']");b.value=editToDisplay(this.editModel.workTime.m),c.value=editToDisplay(this.editModel.workTime.s);break;case"rest":var d=this.restBlock.querySelector("input[data-type='min'] "),e=this.restBlock.querySelector("input[data-type='sec']");d.value=editToDisplay(this.editModel.restTime.m),e.value=editToDisplay(this.editModel.restTime.s);break;case"coffee":var f=this.coffeeBlock.querySelector("input[data-type='min'] "),g=this.coffeeBlock.querySelector("input[data-type='sec']");f.value=editToDisplay(this.editModel.coffeeTime.m),g.value=editToDisplay(this.editModel.coffeeTime.s);}}}]),a}(),EditController=function(){function a(b,c){_classCallCheck(this,a),this.editModel=b,this.editView=c,this.minuses=document.querySelectorAll(".minus"),this.pluses=document.querySelectorAll(".plus"),this.minInputs=document.querySelectorAll("input[data-type='min'] "),this.secInputs=document.querySelectorAll("input[data-type='sec'] "),this.saveBtn=document.getElementById("saveData"),this.bindEvents()}return _createClass(a,[{key:"bindEvents",value:function(){this.saveBtn.addEventListener("click",this.saveData.bind(this));var a=this;console.log(this.minuses),a.minuses.forEach(function(b){b.addEventListener("click",a.minusClick.bind(a,b))}),a.pluses.forEach(function(b){b.addEventListener("click",a.plusClick.bind(a,b))}),a.minInputs.forEach(function(b){b.addEventListener("change",a.minChange.bind(a,b))}),a.secInputs.forEach(function(b){b.addEventListener("change",a.secChange.bind(a,b))})}},{key:"minusClick",value:function(a){var b=a.parentNode.getAttribute("data-timeType"),c=b+"Time";console.log(this.editModel[c].m),0<this.editModel[c].m&&this.editModel.minusMin(b)}},{key:"plusClick",value:function(a){var b=a.parentNode.getAttribute("data-timeType"),c=b+"Time";console.log(this.editModel[c].m),59>this.editModel[c].m&&this.editModel.plusMin(b)}},{key:"minChange",value:function(a){var b=a.parentNode.getAttribute("data-timeType"),c=cleanValue(a.value);this.editModel.changeMin(b,c)}},{key:"secChange",value:function(a){var b=a.parentNode.getAttribute("data-timeType"),c=cleanValue(a.value);this.editModel.changeSec(b,c)}},{key:"saveData",value:function(){this.editModel.changeMainData(),this.editView.closeModal()}}]),a}();(function(){changeFavicon("./img/work.ico");var a=new Model,b=new View(a),c=new Controller(a,b),d=new EditModel(a),e=new EditView(d),f=new EditController(d,e)})(document);